version: "3.8"

services:
  prefect-server:
    build:
      context: .
      dockerfile: Dockerfile.prefect
    ports:
      - 4200:4200
      - 4201:4201
    environment:
      - PREFECT_API_URL=http://localhost:4200/api
      - PREFECT_HOME=/root/.prefect
    volumes:
      - ./flows:/app/flows
      - ./dask_jobs:/app/dask_jobs
      - ./data:/app/data
    healthcheck:
      test: sh - c "curl -f http://localhost:4200/api/health"
      interval: 30s
      timeout: 60s
      retries: 3

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=sales_db
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
    ports:
      - 5432:5432
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: sh -c "pg_isready -U admin"
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - minio_data:/data
    healthcheck:
      test: sh -c "mc ready local"
      interval: 10s
      timeout: 5s
      retries: 5

  # docker run -it --network tobd_project_default \
  #   tobd_project_prefect-server dask-worker tcp://prefect-server:8786
  # docker-compose exec prefect-server python /app/dask_jobs/model_training.py

  streamlit:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - 8501:8501
    volumes:
      - ./dashboard:/app/dashboard
      - ./data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=sales_db
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
    healthcheck:
      test: sh -c "curl --fail http://localhost:8501/_stcore/health"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  postgres_data:
  minio_data:
